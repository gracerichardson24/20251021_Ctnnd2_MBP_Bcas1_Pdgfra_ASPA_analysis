---
title: "bcas1_mbp_analysis"
format: html
---



```{r}
#packages
if(!require(lsmeans)){install.packages("lsmeans")}
if(!require(multcompView)){install.packages("multcompView")}
if(!require(dplyr)){install.packages("dplyr")}
if(!require(rcompanion)){install.packages("rcompanion")}
if(!require(rcompanion)){install.packages("ggprism")}

library(tidyverse)
library(stringr)
library(car)
library(FSA)
library(ggpubr)
library(ggbeeswarm)
library(ggprism)
library(ragg)

if(!require(psych)){install.packages("psych")}
if(!require(FSA)){install.packages("FSA")}
if(!require(lattice)){install.packages("lattice")}
if(!require(lsr)){install.packages("lsr")} 
```
```{r}

#reading in csv files and cleaning

#Section Data
Section_data <- read.csv("DATA/merged_data_section.csv")

Section_data <- Section_data %>%
  extract(
    Image.Name,
    into = c("Animal", "Sex", "Genotype", "slice", "hemisphere"),
    regex = "^([0-9]{6})_([FM])_([A-Z]{2})_s([0-9]+)h([0-9]+)$",
    remove = FALSE
  )


#Cell Data
Detections_data <- read.csv("DATA/merged_data_cell.csv")

Detections_data <- Detections_data %>%
  mutate(
    # Remove optional 'csv' suffix
    Image.Name = str_remove(Image.Name, "csv$"),
    # Extract components with regex
    Animal      = str_extract(Image.Name, "^[0-9]+"),
    Sex         = str_extract(Image.Name, "_[FM]_") %>% str_remove_all("_"),
    Genotype    = str_extract(Image.Name, "_(WT|KO)_") %>% str_remove_all("_"),
    slice       = str_extract(Image.Name, "s[0-9]+") %>% str_remove("s"),
    hemisphere  = str_extract(Image.Name, "h[0-9]+") %>% str_remove("h")
  )

Height_data <- read.csv("DATA/heights_widths.csv")

Height_data <- Height_data %>%
  extract(
    Image,
    into = c("Animal", "Sex", "Genotype", "slice", "hemisphere"),
    # Look for pattern near the end of the filename
    regex = "([0-9]{6})_([FM])_([A-Z]{2})_s([0-9]+)h([0-9]+)",
    remove = FALSE
  )


```

```{r}
Section_data_height <- full_join(
  Section_data,
  Height_data,
  by = c("Animal", "Sex", "Genotype", "slice", "hemisphere")
)

Detections_data_height <- full_join(
  Detections_data,
  Height_data,
  by = c("Animal", "Sex", "Genotype", "slice", "hemisphere")
)

Detections_data_height$Bcas1 <- ifelse(Detections_data_height$Type == 1, 1, 0)
Detections_data_height$Bcas1.MBP <- ifelse(Detections_data_height$Type == 2, 1, 0)

```

```{r}

imageframe_BCas1MBP <- Detections_data_height %>%
  group_by(Animal, Genotype, hemisphere, slice) %>%  # <— each unique combo = one image
  summarise(
    Total_cells = n(),
    total_Bcas1 = sum(Bcas1, na.rm = TRUE),
    total_Bcas1MBP = sum(Bcas1.MBP, na.rm = TRUE),
    max_value = max(`Y`, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    # calculate image area (in mm²) from your scaling constants
    Area = (max_value / 879.1) * (500 / 879.1),
    # convert to densities
    Bcas1_per_area = total_Bcas1 / Area,
    Bcas1MBP_per_area = total_Bcas1MBP / Area,
    Olig2_per_area = Total_cells / Area
  )

# optionally write to CSV
write.csv(imageframe_BCas1MBP, "imageframe_combined_detections_Bcas1MBP.csv", row.names = FALSE)


```
```{r}
animal_frame_BCas1MBP <- imageframe_BCas1MBP %>%
  group_by(Animal, Genotype) %>%
  summarise(
    n_images = n(),
    # totals across all images
    total_Olig2 = sum(Total_cells, na.rm = TRUE),
    total_Bcas1_count = sum(total_Bcas1, na.rm = TRUE),
    total_Bcas1MBP_count = sum(total_Bcas1MBP, na.rm = TRUE),
    # averages across images (for per-image statistics)
    mean_olig2 = mean(Total_cells, na.rm = TRUE),
    mean_olig2_per_area = mean(Olig2_per_area, na.rm = TRUE),
    mean_Bcas1 = mean(total_Bcas1, na.rm = TRUE),
    mean_Bcas1_per_area = mean(Bcas1_per_area, na.rm = TRUE),
    mean_BCas1MBP = mean(total_Bcas1MBP, na.rm = TRUE),
    mean_BCas1MBP_per_area = mean(Bcas1MBP_per_area, na.rm = TRUE),
    total_area = sum(Area, na.rm = TRUE),  # total area across all images
    .groups = "drop"
  ) %>%
  mutate(
    # per-animal densities (weighted by total area)
    olig2_per_area = total_Olig2 / total_area,
    Bcas1_per_area = total_Bcas1_count / total_area,
    Bcas1MBP_per_area = total_Bcas1MBP_count / total_area
  )
```

```{r}
#BINNED ANALYSIS MODIFIED FROM GABI

#obtaining maximum Y value for each image and normalizing their Y values to that to create and sort cells into 10 equal bins 
combined_detections_BCas1MBPbinned <- Detections_data_height %>%
  group_by(Image) %>%
  mutate(
    Y_max = max(`Y`, na.rm = TRUE),
    Y_norm = `Y` / Y_max,
    bin = 10 * round(Y_norm + 0.05, digits = 1)
  ) %>%
  ungroup()

# Assume df has columns: Image, Class

# First, get unique image IDs
unique_images <- unique(combined_detections_BCas1MBPbinned$Image)
# Initialize empty results data frame
combined_detections_BCas1MBPbinned_counts <- data.frame(
  Image = character(),
  bin = integer(),
  Animal = character(),
  Genotype = character(),
  Bcas1 = numeric(),
  Bcas1.MBP = numeric(),
  Olig2 = numeric(),
  stringsAsFactors = FALSE
)

# Loop through images and bins
unique_images <- unique(combined_detections_BCas1MBPbinned$Image)

for (img in unique_images) {
  for (b in 1:10) {
    temp <- combined_detections_BCas1MBPbinned %>%
      filter(Image == img, bin == b)
    
    if (nrow(temp) == 0) next
    
    area_mm2 <- ((temp$Y_max[1] / 10) / 879.1) * (500 / 879.1)
    
    Bcas1_count <- sum(temp$Bcas1 == "1")
    Bcas1_MBP_count <- sum(temp$Bcas1.MBP == "1")
    Olig2_count <- Bcas1_count + Bcas1_MBP_count  # sum of raw counts
    
    # Convert to densities (counts per mm²)
    Bcas1_density <- Bcas1_count / area_mm2
    Bcas1_MBP_density <- Bcas1_MBP_count / area_mm2
    Olig2_density <- Olig2_count / area_mm2
    
    # Add results
    combined_detections_BCas1MBPbinned_counts <- rbind(
      combined_detections_BCas1MBPbinned_counts,
      data.frame(
        Image = img,
        bin = b,
        Animal = unique(temp$Animal),
        Genotype = unique(temp$Genotype),
        Bcas1_pos = Bcas1_density,
        Bcas1_pos_MBP_pos = Bcas1_MBP_density,
        Olig2 = Olig2_density
      )
    )
  }
}


# View result
print(combined_detections_BCas1MBPbinned_counts)
```

```{r}
combined_detections_BCas1MBPbinned_counts_animal <- combined_detections_BCas1MBPbinned_counts %>%
  group_by(Genotype, Animal, bin) %>%
  summarise(Bcas1_pos = mean(Bcas1_pos),
            Bcas1_pos_MBP_pos = mean(Bcas1_pos_MBP_pos),
            Olig2 = mean(Olig2),
            .groups = "drop")

# make 'bin' a factor so all 10 values are evaluated separately
combined_detections_BCas1MBPbinned_counts_animal$bin <- as.factor(combined_detections_BCas1MBPbinned_counts_animal$bin)

print(combined_detections_BCas1MBPbinned_counts_animal)
```

```{r}
Olig2 = lm(Olig2 ~ bin * Genotype,
           data = combined_detections_BCas1MBPbinned_counts_animal)
summary(Olig2)
Anova(Olig2, type = "II")
```
```{r}
library(plotrix)
#line plot for Bcas+ Counts
combined_detections_BCas1MBPbinned_counts_animal_summary <- combined_detections_BCas1MBPbinned_counts_animal %>%
  group_by(bin, Genotype) %>%
  summarise(
    mean_Olig2 = mean(Olig2),
    se_Olig2 = std.error(Olig2),
    .groups = "drop"
  )
#reorder so WT is listed first in legend
combined_detections_BCas1MBPbinned_counts_animal_summary$Genotype <- factor(combined_detections_BCas1MBPbinned_counts_animal_summary$Genotype, levels = c("WT", "KO"))

# Create ggplot with lines and shaded error regions
Olig2_binned_density_plot <- # Create the plot
ggplot(combined_detections_BCas1MBPbinned_counts_animal_summary, aes(x = bin, y = mean_Olig2, color = Genotype, group = Genotype)) +
  geom_line(size = 1) +  # Line plot for mean Cell.Counts
  geom_point(size = 3, alpha = 0.5) +
  geom_ribbon(aes(ymin = mean_Olig2 - se_Olig2, ymax = mean_Olig2 + se_Olig2, fill = Genotype), alpha = 0.2, color = NA) +  # Error ribbon for standard deviation
  labs(
    x = "Distance from Pia (% total cortical thickness)",
    y = expression("cells / " ~ mm^2),
    color = "Genotype",
    fill = "Genotype"
  ) +
  theme_minimal()  +
  scale_colour_manual(values = c("dodgerblue", "firebrick1")) +
  scale_fill_manual(values = c("dodgerblue", "firebrick1")) +
  theme(legend.position = "bottom")  # Optional: Adjust legend position
png(filename = "p30_Ctnnd2_lineplot_Olig2_counts_binned.png", width = 1200, height = 850, res = 300)
  Olig2_binned_density_plot
  dev.off()
Olig2_binned_density_plot
```


```{r}
Bcas1_pos = lm(Bcas1_pos ~ bin * Genotype,
           data = combined_detections_BCas1MBPbinned_counts_animal)
summary(Bcas1_pos)
Anova(Bcas1_pos, type = "II")
```
```{r}
library(plotrix)
#line plot for Bcas+ Counts
combined_detections_BCas1MBPbinned_counts_animal_summary <- combined_detections_BCas1MBPbinned_counts_animal %>%
  group_by(bin, Genotype) %>%
  summarise(
    mean_Bcas1_pos = mean(Bcas1_pos),
    se_Bcas1_pos = std.error(Bcas1_pos),
    .groups = "drop"
  )
#reorder so WT is listed first in legend
combined_detections_BCas1MBPbinned_counts_animal_summary$Genotype <- factor(combined_detections_BCas1MBPbinned_counts_animal_summary$Genotype, levels = c("WT", "KO"))

# Create ggplot with lines and shaded error regions
Bcas1_pos_binned_density_plot <- # Create the plot
ggplot(combined_detections_BCas1MBPbinned_counts_animal_summary, aes(x = bin, y = mean_Bcas1_pos, color = Genotype, group = Genotype)) +
  geom_line(size = 1) +  # Line plot for mean Cell.Counts
  geom_point(size = 3, alpha = 0.5) +
  geom_ribbon(aes(ymin = mean_Bcas1_pos - se_Bcas1_pos, ymax = mean_Bcas1_pos + se_Bcas1_pos, fill = Genotype), alpha = 0.2, color = NA) +  # Error ribbon for standard deviation
  labs(
    x = "Distance from Pia (% total cortical thickness)",
    y = expression("cells / " ~ mm^2),
    color = "Genotype",
    fill = "Genotype"
  ) +
  theme_minimal()  +
  scale_colour_manual(values = c("dodgerblue", "firebrick1")) +
  scale_fill_manual(values = c("dodgerblue", "firebrick1")) +
  theme(legend.position = "bottom")  # Optional: Adjust legend position
png(filename = "p30_Ctnnd2_lineplot_Bcas1_pos_counts_binned.png", width = 1200, height = 850, res = 300)
  Bcas1_pos_binned_density_plot
  dev.off()
Bcas1_pos_binned_density_plot
```
```{r}
Bcas1_pos_MBP_pos = lm(Bcas1_pos_MBP_pos ~ bin * Genotype,
           data = combined_detections_BCas1MBPbinned_counts_animal)
summary(Bcas1_pos_MBP_pos)
Anova(Bcas1_pos_MBP_pos, type = "II")
```
```{r}
library(plotrix)
#line plot for Bcas+ Counts
combined_detections_BCas1MBPbinned_counts_animal_summary <- combined_detections_BCas1MBPbinned_counts_animal %>%
  group_by(bin, Genotype) %>%
  summarise(
    mean_Bcas1_pos_MBP_pos = mean(Bcas1_pos_MBP_pos),
    se_Bcas1_pos_MBP_pos = std.error(Bcas1_pos_MBP_pos),
    .groups = "drop"
  )
#reorder so WT is listed first in legend
combined_detections_BCas1MBPbinned_counts_animal_summary$Genotype <- factor(combined_detections_BCas1MBPbinned_counts_animal_summary$Genotype, levels = c("WT", "KO"))

# Create ggplot with lines and shaded error regions
Bcas1_pos_MBP_pos_binned_density_plot <- # Create the plot
ggplot(combined_detections_BCas1MBPbinned_counts_animal_summary, aes(x = bin, y = mean_Bcas1_pos_MBP_pos, color = Genotype, group = Genotype)) +
  geom_line(size = 1) +  # Line plot for mean Cell.Counts
  geom_point(size = 3, alpha = 0.5) +
  geom_ribbon(aes(ymin = mean_Bcas1_pos_MBP_pos - se_Bcas1_pos_MBP_pos, ymax = mean_Bcas1_pos_MBP_pos + se_Bcas1_pos_MBP_pos, fill = Genotype), alpha = 0.2, color = NA) +  # Error ribbon for standard deviation
  labs(
    x = "Distance from Pia (% total cortical thickness)",
    y = expression("cells / " ~ mm^2),
    color = "Genotype",
    fill = "Genotype"
  ) +
  theme_minimal()  +
  scale_colour_manual(values = c("dodgerblue", "firebrick1")) +
  scale_fill_manual(values = c("dodgerblue", "firebrick1")) +
  theme(legend.position = "bottom")  # Optional: Adjust legend position
png(filename = "p30_Ctnnd2_lineplot_Bcas1_pos_MBP_pos_counts_binned.png", width = 1200, height = 850, res = 300)
  Bcas1_pos_MBP_pos_binned_density_plot
  dev.off()
Bcas1_pos_MBP_pos_binned_density_plot
```
```{r}
Imageframe_data <- read.csv("imageframe_combined_detections_Bcas1MBP.csv")


animal_frame_BCas1MBP$Genotype <- factor(animal_frame_BCas1MBP$Genotype, levels = c("WT", "KO"))
imageframe_BCas1MBP$Genotype <- factor(imageframe_BCas1MBP$Genotype, levels = c("WT", "KO"))


summary_stats <- animal_frame_BCas1MBP %>%
  group_by(Genotype) %>%
  summarise(
    MeanCount = mean(mean_olig2_per_area, na.rm = TRUE),
    SEM = sd(mean_olig2_per_area, na.rm = TRUE)/sqrt(n()),
    .groups = 'drop'
  )

Olig2_Bcas1MBP_plot <- ggplot(data = animal_frame_BCas1MBP, aes(x = Genotype, y = mean_olig2_per_area)) +
  geom_col(data = summary_stats, aes(y = MeanCount, fill = Genotype), alpha = 0.4) +
  geom_errorbar(
    data = summary_stats,
    aes(x = Genotype, ymin = MeanCount - SEM, ymax = MeanCount + SEM),
    width = 0.2,
    color = "black",
    inherit.aes = FALSE
  ) +
  geom_jitter(data = animal_frame_BCas1MBP, aes(color = Genotype, y = mean_olig2_per_area), width = 0.2, size = 2, alpha = 0.9) +
  geom_jitter (data = imageframe_BCas1MBP, aes(color = Genotype, y = Olig2_per_area), width = 0.2, size = 2, alpha = 0.2) +
  theme_minimal() +
  xlab("") +
  ylab("Mean Olig2+ Cells / "~ mm^2) +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("dodgerblue", "firebrick1")) +
  scale_color_manual(values = c("dodgerblue", "firebrick1"))

ggsave("Olig2_Bcas1MBP_density.png", plot = Olig2_Bcas1MBP_plot,
       width = 2, height = 4, dpi = 300)
Olig2_Bcas1MBP_plot
```
```{r}
Imageframe_data <- read.csv("imageframe_combined_detections_Bcas1MBP.csv")


animal_frame_BCas1MBP$Genotype <- factor(animal_frame_BCas1MBP$Genotype, levels = c("WT", "KO"))
imageframe_BCas1MBP$Genotype <- factor(imageframe_BCas1MBP$Genotype, levels = c("WT", "KO"))


summary_stats <- animal_frame_BCas1MBP %>%
  group_by(Genotype) %>%
  summarise(
    MeanCount = mean(mean_Bcas1_per_area, na.rm = TRUE),
    SEM = sd(mean_Bcas1_per_area, na.rm = TRUE)/sqrt(n()),
    .groups = 'drop'
  )

Bcas1_Bcas1MBP_plot <- ggplot(data = animal_frame_BCas1MBP, aes(x = Genotype, y = mean_Bcas1_per_area)) +
  geom_col(data = summary_stats, aes(y = MeanCount, fill = Genotype), alpha = 0.4) +
  geom_errorbar(
    data = summary_stats,
    aes(x = Genotype, ymin = MeanCount - SEM, ymax = MeanCount + SEM),
    width = 0.2,
    color = "black",
    inherit.aes = FALSE
  ) +
  geom_jitter(data = animal_frame_BCas1MBP, aes(color = Genotype, y = mean_Bcas1_per_area), width = 0.2, size = 2, alpha = 0.9) +
  geom_jitter (data = imageframe_BCas1MBP, aes(color = Genotype, y = Bcas1_per_area), width = 0.2, size = 2, alpha = 0.2) +
  theme_minimal() +
  xlab("") +
  ylab("Mean Bcas1+ Cells / "~ mm^2) +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("dodgerblue", "firebrick1")) +
  scale_color_manual(values = c("dodgerblue", "firebrick1"))

ggsave("Bcas1_Bcas1MBP_density.png", plot = Bcas1_Bcas1MBP_plot,
       width = 2, height = 4, dpi = 300)
Bcas1_Bcas1MBP_plot
```
```{r}
Imageframe_data <- read.csv("imageframe_combined_detections_Bcas1MBP.csv")


animal_frame_BCas1MBP$Genotype <- factor(animal_frame_BCas1MBP$Genotype, levels = c("WT", "KO"))
imageframe_BCas1MBP$Genotype <- factor(imageframe_BCas1MBP$Genotype, levels = c("WT", "KO"))


summary_stats <- animal_frame_BCas1MBP %>%
  group_by(Genotype) %>%
  summarise(
    MeanCount = mean(mean_BCas1MBP_per_area, na.rm = TRUE),
    SEM = sd(mean_BCas1MBP_per_area, na.rm = TRUE)/sqrt(n()),
    .groups = 'drop'
  )

Bcas1MBP_Bcas1MBP_plot <- ggplot(data = animal_frame_BCas1MBP, aes(x = Genotype, y = mean_BCas1MBP_per_area)) +
  geom_col(data = summary_stats, aes(y = MeanCount, fill = Genotype), alpha = 0.4) +
  geom_errorbar(
    data = summary_stats,
    aes(x = Genotype, ymin = MeanCount - SEM, ymax = MeanCount + SEM),
    width = 0.2,
    color = "black",
    inherit.aes = FALSE
  ) +
  geom_jitter(data = animal_frame_BCas1MBP, aes(color = Genotype, y = mean_BCas1MBP_per_area), width = 0.2, size = 2, alpha = 0.9) +
  geom_jitter (data = imageframe_BCas1MBP, aes(color = Genotype, y = Bcas1MBP_per_area), width = 0.2, size = 2, alpha = 0.2) +
  theme_minimal() +
  xlab("") +
  ylab("Mean Bcas1+, MBP+ Cells / "~ mm^2) +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("dodgerblue", "firebrick1")) +
  scale_color_manual(values = c("dodgerblue", "firebrick1"))

ggsave("Bcas1MBP_Bcas1MBP_density.png", plot = Bcas1MBP_Bcas1MBP_plot,
       width = 2, height = 4, dpi = 300)
Bcas1MBP_Bcas1MBP_plot
```

